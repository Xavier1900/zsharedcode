#summary JQueryElement 示例-图书列表
#labels Phase-Implementation
<font face="microsoft yahei">
=== Default.aspx 代码 ===
{{{
<%--
wiki 成员参考:
http://code.google.com/p/zsharedcode/wiki/JQueryElement
wiki 分析&示例:
http://code.google.com/p/zsharedcode/wiki/JESBookListDoc
JE 是项目 zsharedcode 的一部分, 您可以参考 http://code.google.com/p/zsharedcode/.
所有项目源码托管地址: http://panzer.codeplex.com/.
--%>

<%@ Page Language="C#" %>

<%@ Register Namespace="zoyobar.shared.panzer.ui.jqueryui" TagPrefix="je" %>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<script runat="server">

</script>
<html xmlns="http://www.w3.org/1999/xhtml">
<head runat="server">
	<title>书店 - JQueryElement 示例</title>
	<link rel="stylesheet" href="../css/ui-lightness/jquery-ui-1.8.11.custom.css" />
	<script type="text/javascript" src="../js/jquery-1.5.1.min.js"></script>
	<script type="text/javascript" src="../js/jquery-ui-1.8.11.custom.min.js"></script>
	<style type="text/css">
		.book-header span
		{
			font-weight: bold;
			width: 200px;
			display: inline-block;
		}
		.book-item span
		{
			width: 200px;
			display: inline-block;
		}
	</style>
</head>
<body>
	<form id="formHome" runat="server">
	<a href="login/Default.aspx">登录</a> <a href="register/Default.aspx">注册</a>
	<je:JQueryElement ID="jeBook" runat="server" ElementType="Div">
		<WidgetSetting Type="empty">
			<AjaxSettings>
				<je:AjaxSettingEdit DataType="json" Url="book/GetBook.ashx" WidgetEventType="__init">
					<Events>
						<je:EventEdit Type="success" Value="loadBook" />
					</Events>
				</je:AjaxSettingEdit>
			</AjaxSettings>
		</WidgetSetting>
		<RepeaterSetting IsRepeatable="true" Field="id;name;price;remark" Attribute="index;count;itemCount">
			<Header>
				<div class="book-header">
					<span>ID</span> <span>书名</span> <span>价格</span> <span>说明</span>
				</div>
			</Header>
			<Item>
				<div class="book-item">
					<span>#id</span> <span>#name</span> <span>#price</span> <span>#remark</span>
				</div>
			</Item>
			<Footer>
				第 @index/@count 页, 共 @itemCount 条
			</Footer>
		</RepeaterSetting>
	</je:JQueryElement>
	<je:JQueryElement ID="jePrev" runat="server" ElementType="Span" IsVariable="true">
		<WidgetSetting Type="button">
			<Options>
				<je:OptionEdit Type="label" Value="'上一页'" />
				<je:OptionEdit Type="disabled" Value="true" />
			</Options>
			<AjaxSettings>
				<je:AjaxSettingEdit DataType="json" Url="book/GetBook.ashx" WidgetEventType="click">
					<Parameters>
						<je:ParameterEdit Name="p" Type="Expression" Value="window.pageIndex - 1" />
					</Parameters>
					<Events>
						<je:EventEdit Type="success" Value="loadBook" />
					</Events>
				</je:AjaxSettingEdit>
			</AjaxSettings>
		</WidgetSetting>
	</je:JQueryElement>
	<je:JQueryElement ID="jeNext" runat="server" ElementType="Span" IsVariable="true">
		<WidgetSetting Type="button">
			<Options>
				<je:OptionEdit Type="label" Value="'下一页'" />
				<je:OptionEdit Type="disabled" Value="true" />
			</Options>
			<AjaxSettings>
				<je:AjaxSettingEdit DataType="json" Url="book/GetBook.ashx" WidgetEventType="click">
					<Parameters>
						<je:ParameterEdit Name="p" Type="Expression" Value="window.pageIndex + 1" />
					</Parameters>
					<Events>
						<je:EventEdit Type="success" Value="loadBook" />
					</Events>
				</je:AjaxSettingEdit>
			</AjaxSettings>
		</WidgetSetting>
	</je:JQueryElement>
	<je:JQueryScript ID="js" runat="server">
		<Html>
		<script type="text/javascript">
			function loadBook(data) {
				eval('[%id:jeBook%]').__bind(data);

				if (data.index <= 1)
					eval('[%id:jePrev%]').button("disable");
				else
					eval('[%id:jePrev%]').button("enable");

				if (data.index >= data.count)
					eval('[%id:jeNext%]').button("disable");
				else
					eval('[%id:jeNext%]').button("enable");

				window.pageIndex = data.index;
			}
		</script>
		</Html>
	</je:JQueryScript>
	<p>讨论, 获取 JQueryElement 最新消息, 请加 QQ 群: 149829251 (JQueryElement 编程)</p>
	</form>
</body>
</html>
}}}

=== book/GetBook.ashx 代码 ===
{{{
<%@ WebHandler Language="C#" Class="BookGetBook" %>

using System;
using System.Web;

using LearnDSTableAdapters;

public class BookGetBook : IHttpHandler
{

	public void ProcessRequest ( HttpContext context )
	{
		context.Response.ContentType = "text/javascript";
		context.Response.Cache.SetNoStore ( );

		int pageIndex = 1;
		int pageSize = 2;

		try
		{ pageIndex = Convert.ToInt32 ( context.Request["p"] ); }
		catch
		{ }

		if ( pageIndex <= 0 )
			pageIndex = 1;

		BookTableAdapter adapter = new BookTableAdapter ( );

		LearnDS.BookDataTable table = new LearnDS ( ).Book;

		adapter.FillByPage ( table, ( pageIndex - 1 ) * pageSize + 1, pageIndex * pageSize );

		int itemCount = new QueryAdapter ( ).GetBookCount ( ).Value;

		string rowJSon = string.Empty;

		foreach ( LearnDS.BookRow row in table )
			rowJSon += "{" + string.Format ( "\"id\": {0}, \"name\": \"{1}\", \"price\": {2}, \"remark\": \"{3}\"", row.ID, row.IsBookNameNull ( ) ? "-" : row.BookName, row.IsPriceNull ( ) ? "-" : row.Price.ToString ( ), row.IsRemarkNull ( ) ? "-" : row.Remark ) + "},";

		context.Response.Write ( "{ \"rows\": [" + rowJSon.TrimEnd ( ',' ) + "], \"index\": " + pageIndex.ToString ( ) + ", \"count\": " + ( ( int ) Math.Ceiling ( ( decimal ) itemCount / ( decimal ) pageSize ) ) + ", \"itemCount\": " + itemCount + " }" );
	}

	public bool IsReusable
	{
		get { return false; }
	}

}
}}}

=== 前提条件 ===
 所有示例代码可以在 http://panzer.codeplex.com/releases/view/61701#DownloadId=212072 下载. 页面需要添加 [http://jqueryui.com/ jQuery UI] 的脚本和样式.

=== 说明 ===
 Default.aspx 中的 jeBook 是用来绑定图书列表的, {{{<RepeaterSetting IsRepeatable="true" Field="id;name;price;remark" Attribute="index;count;itemCount"> ... </RepeaterSetting>}}} 中需要设置 IsRepeatable 为 true, Field 和 Attribute 分别表示参与绑定的 json 数据的属性和行的字段名称, 此外还可以指定 RowsName 属性, 表示 json 中代表行数组的属性名称, 默认为 "rows".

 然后, 通过 Header, Item, Footer 分别设置头尾以及行的模板, 在行模板中可以使用 # 来表示绑定的字段名称 {{{<span>#id</span> <span>#name</span> <span>#price</span> <span>#remark</span>}}}. 此外还有 Empty 模板用于在没有数据时显示, EditItem 暂时不支持.

 jeBook 中的 {{{<je:AjaxSettingEdit DataType="json" Url="book/GetBook.ashx" WidgetEventType="__init"> ... </je:AjaxSettingEdit>}}}, 表示在初始化时, 调用 GetBook.ashx 返回图书的 json 数据, {{{<je:EventEdit Type="success" Value="loadBook" />}}} 则表示在 json 载入成功后使用 javascript 函数 loadBook 来分析结果.

 jePrev 和 jeNext 分别是上一页和下一页的按钮, 同样也是请求 GetBook.ashx 获取图书 json 数据, 只不过通过 {{{<je:ParameterEdit Name="p" Type="Expression" Value="window.pageIndex - 1" />}}} 和  {{{<je:ParameterEdit Name="p" Type="Expression" Value="window.pageIndex + 1" />}}} 传递了页码, pageIndex 是 javascript 变量在 loadBook 函数中设置, 其值是 json 中返回的 index 属性.

 GetBook.ashx 根据传递的页码参数获取图书数据, 并返回对应的 json 数据.

 _这里仅列出部分代码, 可能需要您自己创建窗口, 页面等._

=== 使用 ===
 如果需要单独使用 [JQueryElement JQueryElement], 可以下载 [http://zsharedcode.googlecode.com/svn/trunk/zsharedcode/panzer/.code/JQueryElement.all.cs JQueryElement.all.cs].

 如果下载整个 *panzer* 项目, 请参考 [HowToDownloadAndUse 如何下载使用].
</font>